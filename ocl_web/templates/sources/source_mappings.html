{% extends "sources/source_base.html" %}
{% load i18n %}
{% load ocl_tags %}
{% load bootstrap3 %}
{% load humanize %}


{% block tab-content %}
<div class="container">
<div class="row" ng-controllerx="SourceSearchController">
<form action="." method="get">

<!-- Start left column -->

    <div class="col-md-3">

<!-- Filters -->

		{% for facet in search_facets %}
		<div class="filter-group">
			<div class="filter-group-header">{{ facet.search_filter_name }}</div>
			<div class="filter-group-body">
				{% for facet_key, facet_option in facet.options.iteritems %}
					{% if facet_option.option_num > 0 %}
						<div class="checkbox"><label><input type="checkbox" name="{{ facet.search_filter_name }}" value="{{ facet_option.option_value }}" {% if facet_option.selected %}checked{% endif %}>{{ facet_option.option_name }}&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-muted">{{ facet_option.option_num|intcomma }}</span></label></div>
					{% endif %}
				{% endfor %}
			</div>
		</div>
		{% empty %}
		<h3><small>No filters.</small></h3>
		{% endfor %}

<!-- End left column -->

	</div>

<!-- Start right column -->

	<div class="col-md-9">

<!-- Search selecters -->

		<div class="row" style="padding-top:20px;">
			<div class="col-md-12">
				<div class="btn-group pull-right">
				  	<select name="sort" class="btn btn-default btn-xsm xdropdown-toggle">
				  		{% for sort_option in search_sort_options %}
				    	<option {% if search_sort == sort_option %}selected{% endif %}>{{ sort_option }}</option>
				    	{% endfor %}
				  	</select>
				</div>
				<div class="btn-group pull-right"><span>Sort by:&nbsp;</span></div>

				<div class="btn-group">
				  	<button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
				    	<span class="text-muted">Source Version:</span> <strong>{% if source_version %}{{ source_version }}{% else %}head{% endif %}</strong> <span class="caret"></span>
				  	</button>
				  	<ul class="dropdown-menu" role="menu">
				  	{% for source_version_i in source_versions %}
				  		{% if source.owner_type == 'Organization' %}
				  			{% url 'source-version-mappings' org=source.owner source=source.id source_version=source_version_i.id as source_version_i_url %}
				  		{% else %}
				  			{% url 'source-version-mappings' user=source.owner source=source.id source_version=source_version_i.id as source_version_i_url %}
				  		{% endif %}
				  		<li {% if source_version == source_version_i.id %}class="active"{% endif %}><a href="{{ source_version_i_url }}">{% if source_version_i.released %}<strong>{% endif %}{{ source_version_i.id }}{% if source_version_i.released %}</strong> <span class="text-muted">(Released)</span>{% endif %}</a></li>
				    {% endfor %}
				  	</ul>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12" style="padding-top:20px;padding-bottom:20px;">
                {% simple_pager current_page 'mapping' url=pagination_url %}
		        <div class="input-group">
		            <input type="text" name="q" class="form-control" placeholder="Search mappings within source" value="{{ search_query }}">
		            <span class="input-group-btn">
                        <button class="btn btn-default" type="submit">Search</button>
                    </span>
                </div>
			</div>
		</div>

		{% if_can_change source %}
		{# TODO: Only allow if viewing "head" -- for now mapping is always added to head #}
			<div class="row">
				<div class="col-md-12">
					{% if source.owner_type == 'Organization' %}
						{% url 'mapping-create-for-org' org=source.owner source=source.id as add_concept_url %}
					{% else %}
						{% url 'mapping-create-for-user' user=source.owner source=source.id as add_concept_url %}
					{% endif %}
					<div class="pull-right"><a class="btn btn-link" href="{{ add_concept_url }}"><span class="glyphicon glyphicon-plus"></span>{% trans 'Add Mapping' %}</a></div>
				</div>
			</div>
		{% endif_can_change %}

<!-- Search results -->

        {% for result in results %}

			{# from_concept URL #}
			{% if result.from_source_owner_type == 'Organization' %}
				{% url 'concept-home' org=result.from_source_owner source=result.from_source_name concept=result.from_concept_code as from_concept_url %}
			 {% else %}
				{% url 'concept-home' user=result.from_source_owner source=result.from_source_name concept=result.from_concept_code as from_concept_url %}
	    	{% endif %}

			{# mapping URL #}
			{% if result.owner_type == 'Organization' %}
				{% url 'mapping-home' org=result.owner source=result.source mapping=result.id as mapping_url %}
			{% else %}
				{% url 'mapping-home' user=result.owner source=result.source mapping=result.id as mapping_url %}
			{% endif %}

	    	{# to_concept URL #}
			{% if result.to_concept_url %}
				{# internal mapping: link to concept #}
				{% if result.to_source_owner_type == 'Organization' %}
					{% url 'concept-home' org=result.to_source_owner source=result.to_source_name concept=result.to_concept_code as to_concept_url %}
				{% else %}
					{% url 'concept-home' user=result.to_source_owner source=result.to_source_name concept=result.to_concept_code as to_concept_url %}
				{% endif %}
			{% else %}
				{# external mapping: no link #}
			{% endif %}

			<div class="row row-search-result"> 
				<!--div class="col-md-1 search-result-col-checkbox"><input type="checkbox" /></div-->
				<div class="col-md-1 search-result-col-icon"><span class="glyphicon glyphicon-link search-result-icon"></span></div>
				<div class="col-md-10 search-result-col-content">
					<h4>
						<!-- from_concept -->
						<a href="{{ from_concept_url }}" style="text-decoration: none;">
							<span class="resource-label small concept">
								<span class="resource-label-id"><span class="resource-label-id-icon"><span class="glyphicon glyphicon-tag"></span></span>&nbsp;&nbsp;<span class="resource-label-id-breadcrumb">{{ result.from_source_owner }} / {{ result.from_source_name }} / </span><span class="resource-label-id-code">{{ result.from_concept_code }}</span></span><span class="resource-label-name">{% if result.retired %}<s>{% endif %}{{ result.from_concept_name }}{% if result.retired %}</s>{% endif %}</span>
							</span>
						</a>

						<!-- map_type -->
						<a href="{{ mapping_url }}" style="text-decoration: none;">
							<span class="resource-label small maptype">
								<span class="resource-label-id"><span class="resource-label-id-icon"><span class="glyphicon glyphicon-link"></span></span>&nbsp;&nbsp;<span class="resource-label-id-breadcrumb">{{ result.owner }} / {{ result.source }} / </span></span><span class="resource-label-name">{{ result.map_type }}{% if result.retired %}</s>{% endif %}</span>
							</span>
						</a>

						<!-- to_concept -->
						{% if to_concept_url %}<a href="{{ to_concept_url }}" style="text-decoration: none;">{% endif %}
							<span class="resource-label small concept">
								<span class="resource-label-id"><span class="resource-label-id-icon"><span class="glyphicon glyphicon-tag"></span></span>&nbsp;&nbsp;<span class="resource-label-id-breadcrumb">{{ result.to_source_owner }} / {{ result.to_source_name }} / </span><span class="resource-label-id-code">{{ result.to_concept_code }}</span></span><span class="resource-label-name">{% if result.retired %}<s>{% endif %}{{ result.to_concept_name }}{% if result.retired %}</s>{% endif %}</span>
							</span>
						{% if to_concept_url %}</a>{% endif %}
					</h4>

					<p><span class="text-muted small"><span class="glyphicon glyphicon-calendar"></span>&nbsp;&nbsp;Last updated on {{ result.updated_on|smart_date }}</span></p>
					{% if request.GET.debug %}<pre>{{ result|pprint }}</pre>{% endif %}
				</div>
			</div>
		{% empty %}
			<h3><small>{% trans 'No mappings found' %}</small></h3>
		{% endfor %}

<!-- Pagination -->

        {% if results %}
			<div class="row" style="text-align:center;">
				{% bootstrap_pagination current_page url=pagination_url %}
			</div>
		{% endif %}

<!-- End right column -->

	</div>

</form>
</div>
</div>
{% endblock tab-content %}


{% block resource-debug %}
<h4>URL Parameters</h4><pre>{{ url_params|pprint }}</pre>
<h4>Source</h4><pre>{{ source|pprint }}</pre>
<h4>Concepts</h4><pre>{{ results|pprint }}</pre>
<h4>Facets</h4><pre>{{ search_facets|pprint }}</pre>
{% endblock resource-debug %}